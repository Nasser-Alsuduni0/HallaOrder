{# templates/orders/_order_detail.html #}

<div class="p-4" dir="rtl">
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
    <div>
      <div class="small text-muted">رقم الطلب</div>
      <div class="fw-semibold">#{{ order.pk }}</div>
    </div>
    <div>
      <div class="small text-muted">الحالة</div>
      <span class="badge bg-secondary">{{ order.get_status_display|default:order.status }}</span>
    </div>
    <div>
      <div class="small text-muted">وقت الإنشاء</div>
      <div class="fw-semibold">{{ order.created_at|date:"Y-m-d H:i" }}</div>
    </div>
    <div>
      <div class="small text-muted">طريقة الدفع</div>
      <div class="fw-semibold">
        {% if order.payment_method == "Cash" %}نقدًا{% else %}أونلاين{% endif %}
      </div>
    </div>
  </div>

  <hr class="my-3">

  <div class="row g-3">
    <div class="col-12 col-md-6">
      <div class="border rounded p-3 h-100">
        <div class="fw-semibold mb-2">
          {% with inv=order.invoices.first %}
            {% if inv and inv.customer_name %}
              {{ inv.customer_name }}
            {% elif order.customer %}
              {% if order.customer.get_full_name %}
                {{ order.customer.get_full_name }}
              {% else %}
                {{ order.customer.username|default:"عميل" }}
              {% endif %}
            {% else %}
              عميل
            {% endif %}
          {% endwith %}
        </div>
        <div class="small">
          {% if order.customer %}
            <div><i class="bi bi-person me-1"></i> {% with inv=order.invoices.first %}{{ inv.customer_name|default:order.customer.username|default:"عميل" }}{% endwith %}</div>
            {% if order.customer.email %}<div class="text-muted">{{ order.customer.email }}</div>{% endif %}
          {% else %}
            <div class="text-muted">—</div>
          {% endif %}
          {% with invoice=order.invoices.first %}
            {% if invoice %}
              <hr class="my-2">
              <div class="fw-semibold mb-1">الفاتورة</div>
              {% if invoice.customer_name %}<div>الاسم: {{ invoice.customer_name }}</div>{% endif %}
              {% if invoice.customer_phone %}<div>الجوال: {{ invoice.customer_phone }}</div>{% endif %}
              {% if invoice.customer_email %}<div>البريد: {{ invoice.customer_email }}</div>{% endif %}
              <div class="text-muted">أنشئت: {{ invoice.created_at|date:"Y-m-d H:i" }}</div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div class="border rounded p-3 h-100">
        <div class="fw-semibold mb-2">الفرع</div>
        <div class="small">
          <div><i class="bi bi-shop me-1"></i> {{ order.branch.name }}</div>
          {% if order.branch.address %}<div class="text-muted">{{ order.branch.address }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3 rounded">
    <div class="p-3 fw-semibold">العناصر</div>
    <!-- <div class="table-responsive">
      <table class="table table-sm align-middle m-0">
        <thead class="table-light">
          <tr>
            <th>المنتج</th>
            <th class="text-center">الكمية</th>
            <th>الخيارات</th>
            <th>الإضافات</th>
            <th class="text-end">السعر</th>
          </tr>
        </thead>
        <tbody>
          {% for item in order.items.all %}
            <tr>
              <td class="fw-medium">
                {% if item.product and item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="" style="width:28px;height:28px;border-radius:.4rem;object-fit:cover;" class="ms-2">
                {% endif %}
                {{ item.product.name|default:"منتج" }}
              </td>
              <td class="text-center">{{ item.quantity }}</td>
              <td class="small text-muted">{{ item.product.option_groups.all|default:"—" }}</td>
              <td class="small text-muted">{{ item.addons|default:"—" }}</td>
              <td class="text-end">
                {% if item.product and item.product.price %}
                  ر.س {{ item.product.price|floatformat:2 }}
                {% else %} — {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="text-center text-muted py-4">لا توجد عناصر</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div> -->
    <div class="row g-3">
  {% for item in order.items.all %}
    <div class="col-md-4 col-sm-6">
      <div class="card h-100 border rounded" style="box-shadow: none;">
        
        <!-- صورة المنتج -->
        {% if item.product and item.product.image %}
          <img src="{{ item.product.image.url }}" class="card-img-top" alt="صورة المنتج" style="height: 180px; object-fit: cover;">
        {% endif %}

        <div class="card-body d-flex flex-column">
          
          <!-- اسم المنتج -->
          <h6 class="card-title mb-2">{{ item.product.name|default:"منتج" }}</h6>

          <!-- الكمية -->
          <p class="mb-1"><strong>الكمية:</strong> {{ item.quantity }}</p>

          <!-- الخيارات -->
          {% with item.options.item as options %}
            {% for key, val in options %}
              <div><strong>{{ key }}:</strong> {{ val }}</div>
            {% empty %}
              <div class="text-muted">لا توجد خيارات</div>
            {% endfor %}
          {% endwith %}



          <!-- السعر -->
          <div class="mt-auto text-end">
            {% if item.product and item.product.price %}
              <span class="fw-bold">ر.س {{ item.product.price|floatformat:2 }}</span>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="alert alert-light text-center text-muted">لا توجد عناصر</div>
    </div>
  {% endfor %}
</div>


  </div>

  <div class="d-flex justify-content-end mt-3">
    <div class="fs-6">
      <span class="text-muted">الإجمالي:</span>
      <span class="fw-bold" style="color:#0f5d61;">ر.س {{ order.total_price|floatformat:2 }}</span>
    </div>
  </div>
</div>
