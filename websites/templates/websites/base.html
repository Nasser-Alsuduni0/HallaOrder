{% load bootstrap5 %}
{% load static %}
{% now "Y-m-d" as today_date %}

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>{% block title %}{% firstof website.restaurant.name website.display_name website.slug %}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0ea5e9">
  {% bootstrap_css %}
  {% bootstrap_javascript %}
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
      <script src="https://kit.fontawesome.com/aa8d28d2d0.js" crossorigin="anonymous"></script>

  <style>
    /* حمايات عامة */
    img{max-width:100%;height:auto;vertical-align:middle}
    .hoa-page{min-height:100vh;display:flex;flex-direction:column;background:#f6f7fb}
    main{flex:1}

    /* Topbar */
    .hoa-topbar{background:#fff;border-bottom:1px solid #eef2f7;position:sticky;top:0;z-index:50}
    .hoa-container{max-width:1120px;margin:auto;padding:0 16px}
    .hoa-topbar__inner{display:flex;align-items:center;gap:12px;padding:10px 0;position:relative}
    .hoa-logo{width:36px;height:36px;border-radius:10px;overflow:hidden;display:inline-flex;align-items:center;justify-content:center}
    .hoa-title{font-weight:800}
    .hoa-nav{display:flex;gap:16px;background:#f0f2f68a;border-radius:24px;padding:8px 12px;position:absolute;left:50%;transform:translateX(-50%)}
    .hoa-pill{padding:10px 22px;border:0;background:#fff;border-radius:18px;font-weight:500}
    .hoa-pill.active{border: 3px solid;color:#fff;box-shadow:0 4px 10px rgba(90, 90, 90, 0.35)}
    .hoa-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .hoa-badge{min-width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;background:#ff7a45;color:#fff;border-radius:8px;font-size:12px;padding:0 6px}

    /* شريط الأدوات */
    .hoa-toolbar{display:flex;gap:8px;align-items:center;margin:12px 0}
    .hoa-input{flex:1;padding:12px 14px;border:1px solid #eef1f5;border-radius:12px;background:#f6f7fb;color:#9aa3ad}

    /* Drawer (سلة) — أسماء مُسمّاة لمنع التعارض */
    .hoa-drawer{position:fixed;inset:0;display:none}
    .hoa-drawer.is-open{display:block; z-index: 1000;}
    .hoa-mask{position:absolute;inset:0;background:rgba(0,0,0,.25)}
    .hoa-panel{position:absolute;inset-inline-end:0;top:0;height:100%;width:min(420px,90%);background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.04);display:flex;flex-direction:column}
    .hoa-panel header{padding:14px 16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
    .hoa-list{padding:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
    .hoa-item{display:flex;gap:10px;border:1px solid #f0f2f5;border-radius:12px;padding:10px;background:#fff}
    .hoa-item-img{width:64px;height:64px;border-radius:10px;object-fit:cover;background:#f3f4f6}
    .hoa-panel footer{padding:12px 16px;border-top:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
    .hoa-btn-primary{padding:10px 14px;border:0;border-radius:12px;background:#0ea5e9;color:#fff;cursor:pointer}
    .hoa-btn-ghost{padding:10px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;color:#111;cursor:pointer}

    /* Footer */
    .hoa-footer{background:#fff;border-top:1px solid #eef2f7;margin-top:24px}
    .hoa-footer__inner{max-width:1120px;margin:auto;padding:20px 16px}
    .hoa-footer-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .hoa-footer-grid h4{margin:0 0 10px;font-size:16px}
    .hoa-footer-bottom{margin-top:12px;border-top:1px solid #eef2f7;padding-top:12px;text-align:center;color:#6b7280;font-size:13px}
    @media(max-width:720px){.hoa-footer-grid{grid-template-columns:1fr}}

    /* زر السلة كقرص مع شارة */
    #hoa-open-cart{position:relative;display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:#fff4ef;color:#ff7f50;border:1px solid #ffe1d6;margin-inline-start:auto}
    #hoa-open-cart .hoa-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:#e74c3c;color:#fff;border-radius:999px}
    #hoa-open-cart span:last-child{display:none}
  </style>
  <style>
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  padding-top: 100px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: #fff;
  margin: auto;
  padding: 30px;
  border: 1px solid #888;
  width: 90%;
  max-width: 500px;
  border-radius: 10px;
  position: relative;
}

.close {
  color: #aaa;
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
</style>

  {% block head %}{% endblock %}
</head>
      
<body>
<div class="hoa-page">

    <nav class="navbar navbar-expand-lg bg-body-tertiary p-4" id="nav_color" style="padding: 0 50px;">
    <div class="container-fluid">
      <div class="d-none d-md-flex g-4">
        <div class="hoa-logo" style="width: auto;">
        {% if website.logo %}
          <img src="{{ website.logo.url }}" alt="logo" style="width:100%;height:100%;object-fit:cover">
        {% else %}
          <img src="{% static 'images/placeholders/logo-placeholder.svg' %}" alt="logo" style="width:100%;height:100%;object-fit:cover">
        {% endif %}
        <a class="navbar-brand text_color">{% firstof website.restaurant.name website.display_name website.slug %}</a>
      </div>
      </div>

      <!-- <nav class="hoa-nav" style="background-color: #f0f2f691;">
          <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "dine_in" %}active{% endif %}" onclick="openModal('dineinModal')">داخل المطعم</a>
          <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "pickup" %}active{% endif %}" onclick="openModal('pickupModal')">استلام</a>
          <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "delivery" %}active{% endif %}" onclick="openModal('deliveryModal')">توصيل</a>
      </nav> -->
            <!-- ✅ الشاشات الكبيرة فقط (أزرار عادية) -->
      <nav class="hoa-nav d-none d-md-flex" style="background-color: #f0f2f691;">
        <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "dine_in" %}active{% endif %}" onclick="openModal('dineinModal')">داخل المطعم</a>
        <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "pickup" %}active{% endif %}" onclick="openModal('pickupModal')">استلام</a>
        <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "delivery" %}active{% endif %}" onclick="openModal('deliveryModal')">توصيل</a>
      </nav>

      <!-- ✅ الشاشات الصغيرة فقط (Dropdown) -->
      <div class="dropdown d-flex d-md-none my-2">
        <button class="btn add-btn dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          {% if request.session.order_data.order_method == "dine_in" %} داخل المطعم
          {% elif request.session.order_data.order_method == "pickup" %} الاستلام من الفرع
          {% elif request.session.order_data.order_method == "delivery" %} التوصيل
          {% else %} اختر طريقة الاستلام {% endif %}
        </button>
        <ul class="dropdown-menu w-100 text-center">
          <li><a class="dropdown-item" href="#" onclick="openModal('dineinModal')">داخل المطعم</a></li>
          <li><a class="dropdown-item" href="#" onclick="openModal('pickupModal')">الاستلام من الفرع</a></li>
          <li><a class="dropdown-item" href="#" onclick="openModal('deliveryModal')">التوصيل</a></li>
        </ul>
      </div>


      <div class="d-flex" style="width: auto; justify-content: end;">
        <a  class="nav-link dropdown-toggle text_color" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 20px;">
            قائمة
          </a>
          <ul class="dropdown-menu">
            {% if not request.user.is_authenticated %}
              <li><a href="{% url 'users:customer_login' website.slug %}" class="dropdown-item">تسجيل الدخول</a></li>
              <li><a href="{% url 'users:customer_sign_up' website.slug %}" class="dropdown-item">تسجيل</a></li>
            {% else %}
              <li><a href="{% url 'users:customer_logout_view' website.slug %}" class="dropdown-item">تسجيل الخروج</a></li>
              <li><a href="{% url 'websites:user_orders' website.slug %}" class="dropdown-item">طلباتي</a></li>
            {% endif %}
            {% if last_order_id %}
              <li><a class="dropdown-item" href="{% url 'payments:last_invoice' %}?slug={{ website.slug }}">فاتورتي</a></li>
            {% endif %}
              <li><a class="dropdown-item" href="{% url 'websites:menu' website.slug %}">قائمة الطعام</a></li>
          </ul>

            <button class="hoa-btn" id="hoa-open-cart" type="button" aria-haspopup="dialog" aria-controls="hoa-cart-drawer">
                <span class="hoa-badge">{{ cart_count|default:0 }}</span>
                <i class="bi bi-basket2"></i>
                <span>السلة</span>
          </button>
      </div>
    </div>
  </nav>
  <!-- Topbar -->
  <header class="hoa-topbar" style="padding: 10px; display: none;" >
    <div class="hoa-container hoa-topbar__inner">
      <div class="hoa-logo">
        {% if website.logo %}
          <img src="{{ website.logo.url }}" alt="logo" style="width:100%;height:100%;object-fit:cover">
        {% else %}
          <img src="{% static 'images/placeholders/logo-placeholder.svg' %}" alt="logo" style="width:100%;height:100%;object-fit:cover">
        {% endif %}
      </div>
      <div class="hoa-title">{% firstof website.restaurant.name website.display_name website.slug %}</div>
     
      <!-- tab buttons -->
      <nav class="hoa-nav" style="background-color: #f0f2f691;">
          <!-- <a class="hoa-pill {% if current_tab == 'dine_in' %}active{% endif %}" href="#" onclick="showTab('dine_in')">داخل المطعم</a>
          <a class="hoa-pill {% if current_tab == 'pickup' %}active{% endif %}" href="#" onclick="showTab('pickup')">استلام</a>
          <a class="hoa-pill {% if current_tab == 'delivery' %}active{% endif %}" href="#" onclick="showTab('delivery')">توصيل</a> -->
          <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "dine_in" %}active{% endif %}" onclick="openModal('dineinModal')">داخل المطعم</a>
          <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "pickup" %}active{% endif %}" onclick="openModal('pickupModal')">استلام</a>
          <a href="#" class="hoa-pill {% if request.session.order_data.order_method == "delivery" %}active{% endif %}" onclick="openModal('deliveryModal')">توصيل</a>
      </nav>


      <button class="hoa-btn" id="hoa-open-cart" type="button" aria-haspopup="dialog" aria-controls="hoa-cart-drawer">
        <span class="hoa-badge">{{ cart_count|default:0 }}</span>
        <i class="bi bi-basket2"></i>
        <span>السلة</span>
      </button>

      <!-- إذا لم يكن المستخدم مسجل الدخول، أظهر أزرار التسجيل -->
      {% if not request.user.is_authenticated %}
        <a href="{% url 'users:customer_login' website.slug %}" class="hoa-btn add-btn">تسجيل الدخول</a>
        <a href="{% url 'users:customer_sign_up' website.slug %}" class="hoa-btn add-btn">تسجيل</a>
      {% else %}
        <a href="{% url 'users:customer_logout_view' website.slug %}" class="hoa-btn add-btn">تسجيل الخروج</a>
        <a href="" class="hoa-btn add-btn">طلباتي</a>
      {% endif %}
      {% if last_order_id %}
              <a class="hoa-btn add-btn" href="{% url 'payments:last_invoice' %}?slug={{ website.slug }}">فاتورتي</a>
      {% endif %}

    </div>
  </header>


  <!-- Main -->
  <main>
    <div class="hoa-container mt-4">
      {% block content %}
      <section class="card" style="padding:18px">
        <p>مرحبًا بك في <b>{% firstof website.restaurant.name website.display_name website.slug %}</b>.</p>
      </section>
      {% endblock %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="hoa-footer">
    <div class="hoa-footer__inner">
      <div class="hoa-footer-grid">
        <div>
          <h4>{% firstof website.restaurant.name website.display_name website.slug %}</h4>
          <p>تجربة طلب سهلة وسريعة؛ داخل المطعم أو للاستلام أو التوصيل.</p>
        </div>
        <div>
          <h4>روابط سريعة</h4>
          <div style="display:flex;flex-direction:column;gap:6px">
            <a href="{% url 'websites:menu' website.slug %}">القائمة</a>
            <a href="{% url 'websites:cart' website.slug %}">السلة</a>
            <a href="#">سياسة الخصوصية</a>
          </div>
        </div>
        <div>
          <h4>تواصل</h4>
          <div class="">العنوان: {% firstof website.restaurant.address "—" %}</div>
          <div class="">الهاتف: {% firstof website.restaurant.phone "—" %}</div>
        </div>
      </div>
      <div class="hoa-footer-bottom">تم بناء هذا المتجر بواسطة <b>HalaOrder</b>. جميع الحقوق محفوظة.</div>
    </div>
  </footer>

</div>

<!-- Cart Drawer (namespaced) -->
<div class="hoa-drawer" id="hoa-cart-drawer" aria-hidden="true">
  <div class="hoa-mask" id="hoa-close-cart"></div>
  <aside class="hoa-panel" role="dialog" aria-label="سلة المشتريات">
    <header>
      <div>سلة مشترياتك</div>
      <button class="hoa-btn-ghost" id="hoa-close-cart-btn" type="button">إغلاق</button>
    </header>
    <div class="hoa-list">
      {% if cart and cart|length %}
        {% for i in cart %}
        <div class="hoa-item">
          {% if i.image %}<img class="hoa-item-img" src="{{ i.image }}" alt="">{% endif %}
          <div style="flex:1">
            <div><b>{{ i.name }}</b> <span class="muted">× {{ i.qty }}</span></div>
            <div class="muted">{% if i.size %}الحجم: {{ i.size }} — {% endif %}السعر: SAR {{ i.price }}</div>
          </div>
          <form method="post" action="{% url 'websites:remove_from_cart' website.slug forloop.counter0 %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="hoa-btn-ghost" type="submit" title="حذف"><i class="bi bi-x-lg"></i></button>
          </form>
        </div>
        {% endfor %}
      {% else %}
        <div class="muted">سلتك فارغة.</div>
      {% endif %}

      {% if request.user.is_authenticated %}
        {% if logout_url %}<a href="{{ logout_url }}?next={{ request.path }}">تسجيل الخروج</a>{% endif %}
      {% else %}
        {% if login_url %}<a href="{{ login_url }}?next={{ request.get_full_path|urlencode }}">الدخول</a>{% endif %}
      {% endif %}
    </div>
    <footer>
      <a class="hoa-btn-primary" href="{% url 'websites:cart' website.slug %}">إتمام الطلب</a>
      <span class="muted">العناصر: {{ cart_count|default:0 }}</span>
    </footer>
  </aside> 
</div>



<!-- ===== Modals ===== -->

<!-- Dine-in Modal -->
<div class="modal" id="dineinModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('dineinModal')">&times;</span>
    <h3>حجز داخل المطعم</h3>
    <form method="POST" action="{% url 'websites:save_dinein_details' %}" class="g-2 row">
        {% csrf_token %}
        <label>الفرع:</label>
        <select class="form-select" name="branch_id" id="" required>
          {% for branch in website.restaurant.branches.all %}
            <option value="{{branch.id}}">{{branch.name}}</option>
          {% endfor %}
        </select>
        <label>عدد الأشخاص:</label>
        <input type="number" name="number_of_people" class="form-control" required>
        <label>طلبات خاصة:</label>
        <textarea name="special_requests" class="form-control"></textarea>
        <button type="submit" class="btn add-btn">حفظ</button>
    </form>
  </div>
</div>

<!-- Pickup Modal -->
<div class="modal" id="pickupModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('pickupModal')">&times;</span>
    <h3>الاستلام من الفرع</h3>
    <form method="POST" action="{% url 'websites:save_pickup_details' %}" class="row g-2">
        {% csrf_token %}
        <label>الفرع:</label>
        <select class="form-select" name="branch_id" id="" required>
          {% for branch in website.restaurant.branches.all %}
            <option value="{{branch.id}}">{{branch.name}}</option>
          {% endfor %}
        </select>

        <button type="submit" class="btn add-btn">حفظ</button>
    </form>
  </div>
</div>

<!-- Delivery Modal -->
<div class="modal" id="deliveryModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('deliveryModal')">&times;</span>
    <h3>التوصيل</h3>
    <form method="POST" action="{% url 'websites:save_delivery_details' %}" class="row g-2">
        {% csrf_token %}
        <label>العنوان:</label>
        <input type="text" name="address" class="form-control" required>
        <label>المدينة:</label>
        <input type="text" name="city" class="form-control" required>
        <button type="submit" class="btn add-btn">حفظ</button>
    </form>
  </div>
</div>


<script>
  // Drawer بدون تعارض أسماء
  const drawer = document.getElementById('hoa-cart-drawer');
  const openBtn = document.getElementById('hoa-open-cart');
  const closeMask = document.getElementById('hoa-close-cart');
  const closeBtn = document.getElementById('hoa-close-cart-btn');

  [openBtn, closeMask, closeBtn].forEach(el=>{
    if(!el) return;
    el.addEventListener('click', ()=>{
      drawer.classList.toggle('is-open');
      drawer.setAttribute('aria-hidden', drawer.classList.contains('is-open') ? 'false' : 'true');
    });
  });

 // دالة لتحويل HEX إلى RGB
  function hexToRgb(hex) {
    hex = hex.replace("#", "");
    let bigint = parseInt(hex, 16);
    let r = (bigint >> 16) & 255;
    let g = (bigint >> 8) & 255;
    let b = bigint & 255;
    return [r, g, b];
  }

  // دالة لحساب السطوع (luminance)
  function isDark(hex) {
    let [r, g, b] = hexToRgb(hex);
    // معادلة حساب السطوع (0 = أسود، 255 = أبيض)
    let brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness < 128; // أقل من 128 يعني اللون غامق
  }

  // ألوان من Django template
  let mainColor = "{{website.custom_colors}}";
  let secondaryColor = "{{website.secondary_color}}";

  // تطبيق الألوان مع النصوص
  function applyColor(el, color) {
    el.style.backgroundColor = color;
    el.style.color = isDark(color) ? "#fff" : "#000";
  }

  // تطبيق على العناصر
  applyColor(document.querySelector('.hoa-topbar'), mainColor);
  applyColor(document.querySelector('.hoa-footer'), mainColor);

  applyColor(document.querySelector('#nav_color'), mainColor);
  document.querySelectorAll('.text_color').forEach(el => applyColor(el, mainColor));


  document.querySelectorAll('.add-btn').forEach(el => applyColor(el, secondaryColor));
  document.querySelectorAll('.hoa-btn-primary').forEach(el => applyColor(el, secondaryColor));
  document.querySelectorAll('.pay-btn').forEach(el => applyColor(el, secondaryColor));
  document.querySelectorAll('.hoa-pill').forEach(el => applyColor(el, mainColor));

  
  
  
</script>

<script>
function openModal(id) {
    document.getElementById(id).style.display = "block";
}

function closeModal(id) {
    document.getElementById(id).style.display = "none";
}

// إغلاق المودال عند الضغط خارج المحتوى
window.onclick = function(event) {
    document.querySelectorAll(".modal").forEach(modal => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });
}
</script>



<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
{% block extra_js %}{% endblock %}
</body>
</html>